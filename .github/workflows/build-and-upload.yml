name: Build and Upload HSM Engine

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libcurl4-openssl-dev libjson-c-dev cmake devscripts dpkg-dev gnupg lintian

    - name: Build HSM Engine
      run: |
        cd src
        mkdir -p build
        cd build
        cmake ..
        make

    - name: Create DEBIAN Directory and Control File
      run: |
        mkdir -p ~/hsm-engine-deb/DEBIAN
        mkdir -p ~/hsm-engine-deb/debian
        echo "Source: hsm-engine" > ~/hsm-engine-deb/debian/control  # Секция исходного пакета
        echo "Section: utils" >> ~/hsm-engine-deb/debian/control
        echo "Priority: optional" >> ~/hsm-engine-deb/debian/control
        echo "Maintainer: Andrey V <andrey@kima.finance>" >> ~/hsm-engine-deb/debian/control
        echo "Build-Depends: debhelper (>= 9), cmake, libssl-dev, libcurl4-openssl-dev, libjson-c-dev" >> ~/hsm-engine-deb/debian/control
        echo "Standards-Version: 4.5.0" >> ~/hsm-engine-deb/debian/control
        echo "" >> ~/hsm-engine-deb/debian/control
        echo "Package: hsm-engine" >> ~/hsm-engine-deb/debian/control  # Секция бинарного пакета
        echo "Architecture: amd64" >> ~/hsm-engine-deb/debian/control
        echo "Depends: \${shlibs:Depends}, \${misc:Depends}" >> ~/hsm-engine-deb/debian/control
        echo "Description: Azure Key Vault and Managed HSM Engine for OpenSSL" >> ~/hsm-engine-deb/debian/control
      
    - name: Install HSM Engine and Package
      run: |
        cd src/build
        make install DESTDIR=~/hsm-engine-deb

    - name: Create debian directory and changelog
      run: |
        mkdir -p ~/hsm-engine-deb/debian
        echo "hsm-engine (1.0-1) unstable; urgency=low" > ~/hsm-engine-deb/debian/changelog
        echo "" >> ~/hsm-engine-deb/debian/changelog
        echo "  * Initial release" >> ~/hsm-engine-deb/debian/changelog
        echo "" >> ~/hsm-engine-deb/debian/changelog
        echo " -- Andrey V <andrey@kima.finance>  $(date -R)" >> ~/hsm-engine-deb/debian/changelog

    - name: Create debian/rules
      run: |
        echo "#!/usr/bin/make -f" > ~/hsm-engine-deb/debian/rules
        echo "%:" >> ~/hsm-engine-deb/debian/rules
        echo "\tdh $@" >> ~/hsm-engine-deb/debian/rules
        chmod +x ~/hsm-engine-deb/debian/rules

    - name: Create Source Tarball
      run: |
        cd ~
        tar -czf hsm-engine_1.0.orig.tar.gz hsm-engine-deb

    - name: Build Source Package
      run: |
        cd ~/hsm-engine-deb
        debuild -S -sa

    - name: Sign and Upload to PPA
      env:
        GPG_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        LAUNCHPAD_USERNAME: ${{ secrets.LAUNCHPAD_USERNAME }}
      run: |
        echo "${GPG_KEY}" | gpg --batch --import
        echo "passphrase=${GPG_PASSPHRASE}" > ~/.gnupg/gpg.conf
        echo "use-agent" >> ~/.gnupg/gpg.conf
        debsign --re-sign -k${{ secrets.GPG_KEY_ID }} hsm-engine_1.0-1_amd64.changes
        dput ppa:${{ secrets.LAUNCHPAD_USERNAME }}/kima-hsm-ppa hsm-engine_1.0-1_amd64.changes
